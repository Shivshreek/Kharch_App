<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #dc2626);
            color: white;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }
        
        .sidebar-link:hover, .sidebar-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1050;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        #toast.show {
            opacity: 1;
            visibility: visible;
        }
        
        .toast-success { background: var(--success); }
        .toast-error { background: var(--secondary); }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-70 z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-700 font-semibold">Loading Expense Tracker...</p>
        </div>
    </div>

    <!-- AUTH CONTAINER -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md p-8 space-y-6 card">
            <div class="text-center">
                <div class="mx-auto w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-wallet text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Expense Tracker Pro</h1>
                <p class="text-gray-600 mt-2">Track and split expenses with friends</p>
            </div>
            
            <div id="auth-error" class="text-red-500 text-sm text-center font-medium bg-red-50 p-3 rounded-lg hidden"></div>
            
            <form id="auth-form" class="space-y-5">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <input type="text" id="username" class="form-input pl-10" placeholder="Enter your username" required>
                    </div>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </div>
                        <input type="password" id="password" class="form-input pl-10 pr-10" placeholder="Enter your password" required>
                        <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input id="admin-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-violet-600 focus:ring-violet-500">
                    <label for="admin-checkbox" class="ml-2 block text-sm text-gray-900">Login as Admin</label>
                </div>
                
                <button type="submit" id="login-btn" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login as User</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- DASHBOARD CONTAINER -->
    <div id="dashboard-container" class="hidden w-full h-screen">
        <!-- SIDEBAR -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
        <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-gradient-to-b from-purple-600 to-purple-800 text-white z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            <div class="p-6 border-b border-purple-500">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-wallet text-purple-600"></i>
                    </div>
                    <h1 class="text-xl font-bold">Expense Tracker</h1>
                </div>
            </div>
            
            <nav id="sidebar-nav" class="p-4 space-y-1">
                <a href="#" class="sidebar-link active" data-page="add-expense-page">
                    <i class="fas fa-plus mr-3 w-6 text-center"></i>
                    <span>New Expense</span>
                </a>
                <a href="#" class="sidebar-link" data-page="history-page">
                    <i class="fas fa-history mr-3 w-6 text-center"></i>
                    <span>History</span>
                </a>
                <a href="#" class="sidebar-link" data-page="hisab-page">
                    <i class="fas fa-calculator mr-3 w-6 text-center"></i>
                    <span>Settlements</span>
                </a>
                <a href="#" class="sidebar-link" data-page="stats-page">
                    <i class="fas fa-chart-bar mr-3 w-6 text-center"></i>
                    <span>Stats</span>
                </a>
                <a href="#" class="sidebar-link" data-page="profile-page">
                    <i class="fas fa-user mr-3 w-6 text-center"></i>
                    <span>Profile</span>
                </a>
                <a href="#" class="sidebar-link admin-only hidden" data-page="admin-page">
                    <i class="fas fa-user-shield mr-3 w-6 text-center"></i>
                    <span>Admin Panel</span>
                </a>
                <a href="#" class="sidebar-link" data-page="about-page">
                    <i class="fas fa-info-circle mr-3 w-6 text-center"></i>
                    <span>About</span>
                </a>
                <a href="#" class="sidebar-link" data-page="contact-us-page">
                    <i class="fas fa-envelope mr-3 w-6 text-center"></i>
                    <span>Contact Us</span>
                </a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <div class="lg:ml-64 h-full flex flex-col">
            <!-- HEADER -->
            <header class="flex justify-between items-center p-4 bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="p-2 rounded-lg lg:hidden text-gray-600 hover:bg-gray-100">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-bold text-gray-800">New Expense</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden sm:flex items-center gap-2 bg-purple-50 px-3 py-2 rounded-lg">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <p id="user-display-name" class="text-sm font-medium text-gray-700">User</p>
                    </div>
                    <button id="logout-btn" class="btn btn-secondary text-sm">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </header>
            
            <!-- MAIN CONTENT AREA -->
            <main id="main-content" class="p-4 sm:p-6 flex-grow overflow-y-auto bg-gray-50">
                <!-- Add Expense Page -->
                <div id="add-expense-page" class="page-content active">
                    <div class="card p-6">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-plus text-white"></i>
                            </div>
                            <h2 class="text-2xl font-semibold text-gray-800">Add New Expense</h2>
                        </div>
                        
                        <form id="expense-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label for="expense-date" class="block text-sm font-medium text-gray-600 mb-2">Date</label>
                                    <input type="date" id="expense-date" class="form-input" required>
                                </div>
                                <div>
                                    <label for="total-amount" class="block text-sm font-medium text-gray-600 mb-2">Total Amount</label>
                                    <input type="number" id="total-amount" class="form-input" placeholder="1000.50" required step="0.01">
                                </div>
                                <div class="lg:col-span-2">
                                    <label for="description" class="block text-sm font-medium text-gray-600 mb-2">Description</label>
                                    <input type="text" id="description" class="form-input" placeholder="Dinner, Groceries, etc." required>
                                </div>
                                <div>
                                    <label for="category" class="block text-sm font-medium text-gray-600 mb-2">Category</label>
                                    <select id="category" class="form-input" required>
                                        <option value="Food">Food</option>
                                        <option value="Travel">Travel</option>
                                        <option value="Shopping">Shopping</option>
                                        <option value="Bills">Bills</option>
                                        <option value="Entertainment">Entertainment</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-users mr-2 text-purple-500"></i>
                                    Members
                                </h3>
                                <div id="members-container" class="space-y-3">
                                    <!-- Members will be added here dynamically -->
                                </div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button type="button" id="add-member-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                        <i class="fas fa-user-plus mr-2"></i>Add Member
                                    </button>
                                    <button type="button" id="split-equally-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                        <i class="fas fa-divide mr-2"></i>Split Equally
                                    </button>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-500 mb-2">Quick Add Members:</p>
                                    <div id="quick-add-container" class="flex flex-wrap gap-2">
                                        <!-- Quick add buttons will be added here -->
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-full">
                                <i class="fas fa-save"></i>
                                Save Expense
                            </button>
                        </form>
                    </div>
                </div>

                <!-- History Page -->
                <div id="history-page" class="page-content">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                        <input type="text" id="history-search" class="form-input sm:w-64" placeholder="Search expenses...">
                        <button id="download-csv-btn" class="btn bg-gray-700 text-white hover:bg-gray-800 w-full sm:w-auto">
                            <i class="fas fa-download"></i>
                            Download Report
                        </button>
                    </div>
                    <div id="expense-history" class="space-y-4">
                        <!-- Expenses will be listed here -->
                    </div>
                </div>

                <!-- Settlements Page -->
                <div id="hisab-page" class="page-content">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Settlements</h2>
                        <div class="flex gap-2">
                            <button id="download-settlement-btn" class="btn bg-blue-600 text-white hover:bg-blue-700">
                                <i class="fas fa-file-export"></i>
                                Download Settlements
                            </button>
                            <button id="clear-hisab-btn" class="btn btn-secondary hidden">
                                <i class="fas fa-trash"></i>
                                Clear All Expenses
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Summary</h3>
                    <div id="balances-summary-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <!-- Balance summary will be shown here -->
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Final Settlements</h3>
                    <div id="settlements-container" class="space-y-4">
                        <!-- Settlements will be calculated here -->
                    </div>
                </div>

                <!-- Stats Page -->
                <div id="stats-page" class="page-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Expense Statistics</h2>
                    
                    <div id="stats-summary" class="mb-8 grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Stats summary cards -->
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="font-semibold text-center text-gray-700 mb-4">Expenses by Category</h3>
                            <canvas id="category-chart"></canvas>
                        </div>
                        <div class="card p-6">
                            <h3 class="font-semibold text-center text-gray-700 mb-4">Total Paid by Each Person</h3>
                            <canvas id="paid-by-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profile-page" class="page-content">
                    <div class="card p-6 max-w-2xl mx-auto">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <h2 class="text-2xl font-semibold text-gray-800">Your Profile</h2>
                        </div>
                        <form id="profile-form" class="space-y-6">
                            <!-- Profile form will be loaded here -->
                        </form>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="admin-page" class="page-content">
                    <div class="card p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Add New User</h3>
                        <form id="add-user-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Full Name</label>
                                    <input type="text" id="new-full-name" class="form-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Username</label>
                                    <input type="text" id="new-username" class="form-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                                    <input type="password" id="new-password" class="form-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Mobile</label>
                                    <input type="tel" id="new-mobile" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                                    <input type="email" id="new-email" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Gender</label>
                                    <select id="new-gender" class="form-input">
                                        <option value="">Select</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-full md:w-auto">
                                <i class="fas fa-user-plus"></i>
                                Add User
                            </button>
                        </form>
                    </div>
                    
                    <div class="card p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Manage Users</h3>
                        <div id="user-list-container" class="space-y-4">
                            <!-- Users list will be shown here -->
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Contact Messages</h3>
                        <div id="messages-container" class="space-y-4 max-h-60 overflow-y-auto">
                            <!-- Messages will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- About Page -->
                <div id="about-page" class="page-content">
                    <div class="card p-6 max-w-3xl mx-auto">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-info-circle text-white"></i>
                            </div>
                            <h2 class="text-2xl font-semibold text-gray-800">About Expense Tracker Pro</h2>
                        </div>
                        <div class="prose max-w-none">
                            <p class="text-gray-600 mb-4">This application helps you and your friends track shared expenses easily. Created by Shivshree Kumar, this tool simplifies splitting bills and settling debts with an intuitive interface and powerful features.</p>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 mt-6">
                                <h3 class="font-semibold text-purple-700 mb-2">Key Features</h3>
                                <ul class="list-disc pl-5 text-gray-600 space-y-1">
                                    <li>Track expenses with multiple members</li>
                                    <li>Split bills equally or custom amounts</li>
                                    <li>Visualize spending with charts</li>
                                    <li>Calculate settlements automatically</li>
                                    <li>Export data for record keeping</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Us Page -->
                <div id="contact-us-page" class="page-content">
                    <div class="card p-6 max-w-2xl mx-auto">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-envelope text-white"></i>
                            </div>
                            <h2 class="text-2xl font-semibold text-gray-800">Contact Admin</h2>
                        </div>
                        <form id="contact-form" class="space-y-6">
                            <div>
                                <label for="contact-name" class="block text-sm font-medium text-gray-600 mb-2">Your Name</label>
                                <input type="text" id="contact-name" class="form-input" required readonly>
                            </div>
                            <div>
                                <label for="contact-email" class="block text-sm font-medium text-gray-600 mb-2">Your Email</label>
                                <input type="email" id="contact-email" class="form-input" required>
                            </div>
                            <div>
                                <label for="contact-message" class="block text-sm font-medium text-gray-600 mb-2">Message</label>
                                <textarea id="contact-message" rows="4" class="form-input" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">
                                <i class="fas fa-paper-plane"></i>
                                Send Message
                            </button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODALS -->
    <div id="edit-expense-modal" class="fixed inset-0 items-center justify-center hidden z-50">
        <div class="fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl z-50 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Expense</h3>
            <form id="edit-expense-form" class="space-y-4"></form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast"></div>

    <!-- FIREBASE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, addDoc, getDocs, Timestamp, deleteDoc, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            "apiKey": "AIzaSyBGdWYuD4oeKczwsjDfYckMm_sJu0uWP38",
            "authDomain": "kharch-tracker-79680.firebaseapp.com",
            "projectId": "kharch-tracker-79680",
            "storageBucket": "kharch-tracker-79680.appspot.com",
            "messagingSenderId": "599284399757",
            "appId": "1:599284399757:web:4918fec447c1f408b9ecc4",
            "measurementId": "G-JQM8G7X0YY"
        };
        
        const appId = 'kharch-tracker-shivshree';
        let app, db, auth;
        
        try { 
            app = initializeApp(firebaseConfig); 
            db = getFirestore(app); 
            auth = getAuth(app); 
        } catch(e) { 
            console.error("Firebase initialization failed:", e); 
        }

        // Application State
        const state = {
            currentUser: null,
            expenses: [],
            users: [],
            isAdmin: false,
            allUsersCache: new Map(),
            allExpensesCache: []
        };

        // DOM Elements
        const elements = {
            loader: document.getElementById('loader'),
            authContainer: document.getElementById('auth-container'),
            dashboardContainer: document.getElementById('dashboard-container'),
            authError: document.getElementById('auth-error'),
            authForm: document.getElementById('auth-form'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            pageTitle: document.getElementById('page-title'),
            userDisplayName: document.getElementById('user-display-name'),
            toast: document.getElementById('toast')
        };

        let categoryChartInstance = null;
        let paidByChartInstance = null;

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = elements.toast;
            toast.textContent = message;
            toast.className = '';
            toast.classList.add('show', `toast-${type}`);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function toggleButtonLoading(button, isLoading, originalText) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Page Navigation
        function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update sidebar active state
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Update page title
            const pageTitle = document.querySelector(`[data-page="${pageId}"] span`).textContent;
            elements.pageTitle.textContent = pageTitle;
            
            // Close sidebar on mobile
            elements.sidebar.classList.add('-translate-x-full');
            elements.sidebarOverlay.classList.add('hidden');
            
            // Load page-specific data
            loadPageData(pageId);
        }

        function loadPageData(pageId) {
            switch(pageId) {
                case 'history-page':
                    renderExpenseHistory();
                    break;
                case 'hisab-page':
                    calculateAndDisplaySettlements();
                    break;
                case 'stats-page':
                    generateStats();
                    break;
                case 'profile-page':
                    loadUserProfile();
                    break;
                case 'admin-page':
                    if(state.isAdmin) {
                        fetchAndDisplayUsersForAdmin();
                        fetchAndDisplayMessages();
                    }
                    break;
                case 'contact-us-page':
                    loadContactFormDetails();
                    break;
            }
        }

        // Expense Management
        function addMember(name = '', amount = '') {
            const membersContainer = document.getElementById('members-container');
            const memberDiv = document.createElement('div');
            memberDiv.className = 'flex items-center gap-2 member-row';
            memberDiv.innerHTML = `
                <input type="text" value="${name}" class="form-input flex-grow" placeholder="Member Name" required>
                <input type="number" value="${amount}" class="form-input w-28" placeholder="Amount" step="0.01" required>
                <button type="button" class="remove-member-btn text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button>
            `;
            membersContainer.appendChild(memberDiv);
            
            memberDiv.querySelector('.remove-member-btn').addEventListener('click', () => {
                memberDiv.remove();
            });
        }

        function splitEqually() {
            const totalAmount = parseFloat(document.getElementById('total-amount').value);
            const memberRows = document.querySelectorAll('.member-row');
            
            if (isNaN(totalAmount) || totalAmount <= 0) {
                showToast('Please enter a valid total amount first', 'error');
                return;
            }
            
            if (memberRows.length === 0) {
                showToast('Please add members first', 'error');
                return;
            }
            
            const amountPerPerson = (totalAmount / memberRows.length).toFixed(2);
            
            memberRows.forEach(row => {
                const amountInput = row.querySelector('input[type="number"]');
                amountInput.value = amountPerPerson;
            });
            
            showToast(`Split equally: ₹${amountPerPerson} per person`);
        }

        // Firebase Data Management
        async function fetchAndCacheUsers() {
            try {
                const snapshot = await getDocs(collection(db, `/artifacts/${appId}/public/data/credentials`));
                state.allUsersCache.clear();
                snapshot.forEach(doc => {
                    state.allUsersCache.set(doc.id, { id: doc.id, ...doc.data() });
                });
                setupQuickAddButtons();
            } catch (error) {
                console.error("Error fetching users:", error);
                // Fallback to demo data
                initializeDemoUsers();
            }
        }

        function fetchAndDisplayExpenses() {
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/expenses`), orderBy("createdAt", "desc"));
                
                onSnapshot(q, (snapshot) => {
                    state.allExpensesCache = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(),
                        createdAt: doc.data().createdAt || Timestamp.now()
                    }));
                    
                    renderExpenseHistory();
                    
                    if (document.getElementById('hisab-page').classList.contains('active')) {
                        calculateAndDisplaySettlements();
                    }
                    
                    if (document.getElementById('stats-page').classList.contains('active')) {
                        generateStats();
                    }
                });
            } catch (error) {
                console.error("Error fetching expenses:", error);
                // Fallback to demo data
                initializeDemoExpenses();
            }
        }

        // Demo Data Fallback
        function initializeDemoUsers() {
            state.allUsersCache.set('john', { id: 'john', name: 'John Doe', password: '123', role: 'User' });
            state.allUsersCache.set('jane', { id: 'jane', name: 'Jane Smith', password: '123', role: 'User' });
            state.allUsersCache.set('admin', { id: 'admin', name: 'Admin User', password: 'admin123', role: 'Admin' });
            setupQuickAddButtons();
        }

        function initializeDemoExpenses() {
            state.allExpensesCache = [
                {
                    id: '1',
                    description: 'Dinner at Restaurant',
                    totalAmount: 2500,
                    category: 'Food',
                    members: [
                        { name: 'John Doe', amount: 1250 },
                        { name: 'Jane Smith', amount: 1250 }
                    ],
                    addedBy: 'john',
                    createdAt: Timestamp.fromDate(new Date('2024-01-15'))
                },
                {
                    id: '2',
                    description: 'Movie Tickets',
                    totalAmount: 1200,
                    category: 'Entertainment',
                    members: [
                        { name: 'John Doe', amount: 600 },
                        { name: 'Jane Smith', amount: 600 }
                    ],
                    addedBy: 'jane',
                    createdAt: Timestamp.fromDate(new Date('2024-01-14'))
                }
            ];
            renderExpenseHistory();
        }

        // Authentication
        async function handleLogin(e) {
            e.preventDefault();
            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.innerHTML;
            toggleButtonLoading(loginBtn, true, originalText);

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const isAdminLogin = document.getElementById('admin-checkbox').checked;

            try {
                // Special admin account creation
                if (username === "Shivshree@2004" && password === "Shiv@2004.") {
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/credentials`, username);
                    await setDoc(userDocRef, {
                        name: "Shivshree Kumar",
                        password: password,
                        role: "Super Admin"
                    }, { merge: true });
                    
                    const adminDoc = await getDoc(userDocRef);
                    state.currentUser = { id: adminDoc.id, ...adminDoc.data() };
                } else {
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/credentials`, username);
                    const docSnap = await getDoc(userDocRef);
                    
                    if (docSnap.exists() && docSnap.data().password === password) {
                        if (isAdminLogin && docSnap.data().role !== 'Super Admin') {
                            elements.authError.textContent = 'Admin access denied';
                            elements.authError.classList.remove('hidden');
                            toggleButtonLoading(loginBtn, false, originalText);
                            return;
                        }
                        
                        state.currentUser = { id: docSnap.id, ...docSnap.data() };
                    } else {
                        elements.authError.textContent = 'Invalid username or password';
                        elements.authError.classList.remove('hidden');
                        toggleButtonLoading(loginBtn, false, originalText);
                        return;
                    }
                }
                
                state.isAdmin = state.currentUser.role === 'Super Admin';
                localStorage.setItem('kharchTrackerUser', JSON.stringify(state.currentUser));
                showToast(`Welcome back, ${state.currentUser.name}!`, 'success');
                await showDashboard();
                
            } catch (error) {
                console.error("Login error:", error);
                elements.authError.textContent = 'Login failed. Please try again.';
                elements.authError.classList.remove('hidden');
            }
            
            toggleButtonLoading(loginBtn, false, originalText);
        }

        async function showDashboard() {
            elements.loader.classList.add('hidden');
            elements.authContainer.classList.add('hidden');
            elements.dashboardContainer.classList.remove('hidden');
            
            // Update user info
            elements.userDisplayName.textContent = state.currentUser.name;
            
            // Show/hide admin features
            document.querySelectorAll('.admin-only').forEach(el => {
                el.classList.toggle('hidden', !state.isAdmin);
            });
            
            // Initialize data
            await fetchAndCacheUsers();
            fetchAndDisplayExpenses();
            initializeExpenseForm();
        }

        function showLoginScreen() {
            elements.dashboardContainer.classList.add('hidden');
            elements.authContainer.classList.remove('hidden');
            elements.authForm.reset();
            elements.authError.classList.add('hidden');
            state.currentUser = null;
            localStorage.removeItem('kharchTrackerUser');
        }

        // Expense Form Management
        function initializeExpenseForm() {
            const expenseForm = document.getElementById('expense-form');
            const addMemberBtn = document.getElementById('add-member-btn');
            const splitEquallyBtn = document.getElementById('split-equally-btn');
            
            // Set today's date as default
            document.getElementById('expense-date').valueAsDate = new Date();
            
            // Clear existing members and add current user as first member
            document.getElementById('members-container').innerHTML = '';
            if (state.currentUser && state.currentUser.name) {
                addMember(state.currentUser.name);
            }
            
            // Setup quick add buttons
            setupQuickAddButtons();
            
            // Event listeners
            addMemberBtn.addEventListener('click', () => addMember());
            splitEquallyBtn.addEventListener('click', splitEqually);
            
            expenseForm.addEventListener('submit', handleExpenseSubmit);
        }

        function setupQuickAddButtons() {
            const container = document.getElementById('quick-add-container');
            container.innerHTML = '';
            
            // Add other users as quick add options
            state.allUsersCache.forEach(user => {
                if (user.id !== state.currentUser.id) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-sm hover:bg-indigo-200 transition-colors';
                    button.textContent = user.name.split(' ')[0];
                    button.addEventListener('click', () => {
                        addMember(user.name);
                    });
                    container.appendChild(button);
                }
            });
        }

        async function handleExpenseSubmit(e) {
            e.preventDefault();
            
            const description = document.getElementById('description').value;
            const totalAmount = parseFloat(document.getElementById('total-amount').value);
            const category = document.getElementById('category').value;
            const date = document.getElementById('expense-date').value;
            
            // Validate members
            const memberRows = document.querySelectorAll('.member-row');
            const members = [];
            let totalSplit = 0;
            
            memberRows.forEach(row => {
                const nameInput = row.querySelector('input[type="text"]');
                const amountInput = row.querySelector('input[type="number"]');
                
                const name = nameInput.value.trim();
                const amount = parseFloat(amountInput.value);
                
                if (name && !isNaN(amount)) {
                    members.push({ name, amount });
                    totalSplit += amount;
                }
            });
            
            // Validation
            if (members.length === 0) {
                showToast('Please add at least one member', 'error');
                return;
            }
            
            if (Math.abs(totalSplit - totalAmount) > 0.01) {
                showToast(`Split total (${totalSplit}) doesn't match expense amount (${totalAmount})`, 'error');
                return;
            }
            
            try {
                // Save to Firebase
                await addDoc(collection(db, `/artifacts/${appId}/public/data/expenses`), {
                    description,
                    totalAmount,
                    category,
                    members,
                    addedBy: state.currentUser.id,
                    createdAt: Timestamp.fromDate(new Date(date))
                });
                
                // Reset form
                document.getElementById('expense-form').reset();
                document.getElementById('members-container').innerHTML = '';
                addMember(state.currentUser.name);
                document.getElementById('expense-date').valueAsDate = new Date();
                
                showToast('Expense added successfully!', 'success');
                
            } catch (error) {
                console.error("Error adding expense:", error);
                showToast('Failed to add expense', 'error');
            }
        }

        function renderExpenseHistory() {
            const container = document.getElementById('expense-history');
            
            if (state.allExpensesCache.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No expenses recorded yet</p>';
                return;
            }
            
            container.innerHTML = state.allExpensesCache.map(expense => {
                const date = expense.createdAt?.toDate ? expense.createdAt.toDate() : new Date(expense.createdAt);
                const formattedDate = date.toLocaleDateString('en-IN', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                return `
                    <div class="card p-4 expense-item">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-semibold text-lg text-gray-800">${expense.description}</h3>
                                <p class="text-gray-500 text-sm">${formattedDate} • ${expense.category}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-xl text-purple-600">₹${expense.totalAmount.toFixed(2)}</p>
                                <p class="text-gray-500 text-sm">by ${state.allUsersCache.get(expense.addedBy)?.name || expense.addedBy}</p>
                            </div>
                        </div>
                        <div class="border-t pt-3">
                            ${expense.members.map(member => `
                                <div class="flex justify-between text-sm">
                                    <span>${member.name}</span>
                                    <span class="font-medium">₹${member.amount.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Settlements Calculation
        function calculateAndDisplaySettlements() {
            const settlementsContainer = document.getElementById('settlements-container');
            const balancesContainer = document.getElementById('balances-summary-container');
            
            if (state.allExpensesCache.length === 0) {
                settlementsContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No expenses to calculate settlements</p>';
                balancesContainer.innerHTML = '';
                return;
            }
            
            // Calculate balances
            const balances = {};
            const totalPaid = {};
            const totalShare = {};
            
            // Initialize balances for all users
            state.allUsersCache.forEach(user => {
                balances[user.name] = 0;
                totalPaid[user.name] = 0;
                totalShare[user.name] = 0;
            });
            
            // Calculate totals
            state.allExpensesCache.forEach(expense => {
                const payer = state.allUsersCache.get(expense.addedBy);
                if (payer) {
                    totalPaid[payer.name] += expense.totalAmount;
                }
                
                expense.members.forEach(member => {
                    totalShare[member.name] += member.amount;
                });
            });
            
            // Calculate final balances
            state.allUsersCache.forEach(user => {
                balances[user.name] = (totalPaid[user.name] || 0) - (totalShare[user.name] || 0);
            });
            
            // Display balance summary
            balancesContainer.innerHTML = '';
            state.allUsersCache.forEach(user => {
                const balance = balances[user.name];
                const balanceColor = balance > 0 ? 'text-green-600' : balance < 0 ? 'text-red-600' : 'text-gray-600';
                
                const card = document.createElement('div');
                card.className = 'card p-4';
                card.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${user.name}</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span>Total Paid:</span>
                            <span>₹${(totalPaid[user.name] || 0).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total Share:</span>
                            <span>₹${(totalShare[user.name] || 0).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between border-t pt-1 font-semibold">
                            <span>Balance:</span>
                            <span class="${balanceColor}">₹${balance.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                balancesContainer.appendChild(card);
            });
            
            // Calculate settlements
            const debtors = [];
            const creditors = [];
            
            Object.entries(balances).forEach(([person, balance]) => {
                if (balance < -0.01) {
                    debtors.push({ name: person, amount: -balance });
                } else if (balance > 0.01) {
                    creditors.push({ name: person, amount: balance });
                }
            });
            
            const settlements = [];
            
            while (debtors.length > 0 && creditors.length > 0) {
                debtors.sort((a, b) => a.amount - b.amount);
                creditors.sort((a, b) => b.amount - a.amount);
                
                const debtor = debtors[0];
                const creditor = creditors[0];
                const amount = Math.min(debtor.amount, creditor.amount);
                
                settlements.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: amount
                });
                
                debtor.amount -= amount;
                creditor.amount -= amount;
                
                if (debtor.amount < 0.01) debtors.shift();
                if (creditor.amount < 0.01) creditors.shift();
            }
            
            // Display settlements
            if (settlements.length === 0) {
                settlementsContainer.innerHTML = '<p class="text-center text-green-600 font-semibold py-4">All settled up! No payments needed.</p>';
            } else {
                settlementsContainer.innerHTML = settlements.map(settlement => `
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold">${settlement.from}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">owes</span>
                                <span class="font-bold text-purple-600">₹${settlement.amount.toFixed(2)}</span>
                                <span class="text-gray-500">to</span>
                            </div>
                            <span class="font-semibold">${settlement.to}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Statistics
        function generateStats() {
            const statsSummary = document.getElementById('stats-summary');
            
            if (state.allExpensesCache.length === 0) {
                statsSummary.innerHTML = '<p class="text-gray-500 col-span-2 text-center py-8">No data available for statistics</p>';
                return;
            }
            
            // Calculate total expense
            const totalExpense = state.allExpensesCache.reduce((sum, expense) => sum + expense.totalAmount, 0);
            
            // Calculate expenses by category
            const expensesByCategory = {};
            state.allExpensesCache.forEach(expense => {
                const category = expense.category || 'Other';
                expensesByCategory[category] = (expensesByCategory[category] || 0) + expense.totalAmount;
            });
            
            // Calculate paid by each person
            const paidBy = {};
            state.allExpensesCache.forEach(expense => {
                const payer = state.allUsersCache.get(expense.addedBy);
                if (payer) {
                    paidBy[payer.name] = (paidBy[payer.name] || 0) + expense.totalAmount;
                }
            });
            
            // Display summary
            statsSummary.innerHTML = `
                <div class="stat-card">
                    <p class="text-sm opacity-80">Total Spent</p>
                    <p class="text-3xl font-bold mt-2">₹${totalExpense.toFixed(2)}</p>
                </div>
                <div class="stat-card">
                    <p class="text-sm opacity-80">Total Expenses</p>
                    <p class="text-3xl font-bold mt-2">${state.allExpensesCache.length}</p>
                </div>
            `;
            
            // Create charts
            createCharts(expensesByCategory, paidBy);
        }

        function createCharts(expensesByCategory, paidBy) {
            const categoryCtx = document.getElementById('category-chart').getContext('2d');
            const paidByCtx = document.getElementById('paid-by-chart').getContext('2d');
            
            // Destroy existing charts
            if (categoryChartInstance) categoryChartInstance.destroy();
            if (paidByChartInstance) paidByChartInstance.destroy();
            
            // Category chart
            categoryChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: [
                            '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Paid by chart
            paidByChartInstance = new Chart(paidByCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(paidBy),
                    datasets: [{
                        label: 'Amount Paid',
                        data: Object.values(paidBy),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Profile Management
        function loadUserProfile() {
            const profileForm = document.getElementById('profile-form');
            const user = state.currentUser;
            
            profileForm.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Full Name</label>
                    <input type="text" id="profile-name" class="form-input" value="${user.name || ''}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Password (leave blank to keep current)</label>
                    <input type="password" id="profile-password" class="form-input" placeholder="New password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Mobile</label>
                    <input type="tel" id="profile-mobile" class="form-input" value="${user.mobile || ''}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                    <input type="email" id="profile-email" class="form-input" value="${user.email || ''}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Gender</label>
                    <select id="profile-gender" class="form-input">
                        <option value="">Select</option>
                        <option value="Male" ${user.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${user.gender === 'Female' ? 'selected' : ''}>Female</option>
                        <option value="Other" ${user.gender === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-save"></i>
                    Update Profile
                </button>
            `;
            
            profileForm.onsubmit = updateUserProfile;
        }

        async function updateUserProfile(e) {
            e.preventDefault();
            
            const updates = {
                name: document.getElementById('profile-name').value,
                mobile: document.getElementById('profile-mobile').value,
                email: document.getElementById('profile-email').value,
                gender: document.getElementById('profile-gender').value
            };
            
            const newPassword = document.getElementById('profile-password').value;
            if (newPassword) {
                updates.password = newPassword;
            }
            
            try {
                await updateDoc(doc(db, `/artifacts/${appId}/public/data/credentials`, state.currentUser.id), updates);
                state.currentUser = { ...state.currentUser, ...updates };
                localStorage.setItem('kharchTrackerUser', JSON.stringify(state.currentUser));
                elements.userDisplayName.textContent = state.currentUser.name;
                showToast('Profile updated successfully!', 'success');
            } catch (error) {
                showToast('Failed to update profile', 'error');
            }
        }

        // Admin Functions
        async function fetchAndDisplayUsersForAdmin() {
            const container = document.getElementById('user-list-container');
            container.innerHTML = '';
            
            state.allUsersCache.forEach(user => {
                if (user.role !== 'Super Admin') {
                    const userCard = document.createElement('div');
                    userCard.className = 'card p-4';
                    userCard.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold">${user.name}</h4>
                                <p class="text-sm text-gray-500">Username: ${user.id}</p>
                                <p class="text-sm text-gray-500">${user.mobile || 'No mobile'} • ${user.email || 'No email'}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm edit-user" data-username="${user.id}">Edit</button>
                                <button class="px-3 py-1 bg-red-500 text-white rounded text-sm delete-user" data-username="${user.id}">Delete</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(userCard);
                }
            });
        }

        async function fetchAndDisplayMessages() {
            // This would fetch messages from Firebase
            const container = document.getElementById('messages-container');
            container.innerHTML = '<p class="text-gray-500 text-center">No messages yet</p>';
        }

        // Contact Form
        function loadContactFormDetails() {
            document.getElementById('contact-name').value = state.currentUser.name;
            document.getElementById('contact-email').value = state.currentUser.email || '';
        }

        // Event Listeners
        function initializeEventListeners() {
            // Auth form
            elements.authForm.addEventListener('submit', handleLogin);
            
            // Password toggle
            document.getElementById('toggle-password').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                this.querySelector('i').className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
            });
            
            // Admin checkbox
            document.getElementById('admin-checkbox').addEventListener('change', function() {
                const loginBtn = document.getElementById('login-btn');
                const text = this.checked ? 'Login as Admin' : 'Login as User';
                loginBtn.querySelector('span').textContent = text;
            });
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    switchPage(pageId);
                });
            });
            
            // Mobile menu toggle
            elements.menuToggleBtn.addEventListener('click', () => {
                elements.sidebar.classList.toggle('-translate-x-full');
                elements.sidebarOverlay.classList.toggle('hidden');
            });
            
            // Sidebar overlay
            elements.sidebarOverlay.addEventListener('click', () => {
                elements.sidebar.classList.add('-translate-x-full');
                elements.sidebarOverlay.classList.add('hidden');
            });
            
            // Logout
            elements.logoutBtn.addEventListener('click', showLoginScreen);
            
            // History search
            document.getElementById('history-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const expenseItems = document.querySelectorAll('.expense-item');
                
                expenseItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
        }

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const storedUser = localStorage.getItem('kharchTrackerUser');
                if (storedUser) {
                    try {
                        state.currentUser = JSON.parse(storedUser);
                        state.isAdmin = state.currentUser.role === 'Super Admin';
                        await showDashboard();
                    } catch {
                        showLoginScreen();
                    }
                } else {
                    showLoginScreen();
                }
            } else {
                try {
                    await signInAnonymously(auth);
                } catch(error) {
                    console.error("Auth error:", error);
                    showLoginScreen();
                }
            }
            elements.loader.classList.add('hidden');
        });

        // Initialize Application
        function init() {
            initializeEventListeners();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
